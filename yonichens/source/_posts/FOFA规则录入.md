---
title: FOFA 规则录入
date: 2019-09-26 10:56:20
tags: FOFA
---
最近在接触 <a href="https://fofa.so">FOFA</a>，之前完全是对安全没什么概念的，似乎这个引擎在业界非常有名，最亮眼的应该就是支持网页源码级的全文检索了。这篇讲讲在 FOFA 怎么去录入一条规则。

<h4>规则介绍</h4> 
规则是一个或者多个查询语句组成的表达式，用来识别软、硬件产品。利用规则，做到漏洞快速预警、响应；对漏洞设备做数据统计，分析漏洞影响范围。比如验证某款产品上有bug/漏洞，利用 FOFA 的规则，直接找到该产品型号的所有联网设备。

<h4>规则提取流程</h4>
这里先要区分两类结果，网络服务和网页，网站其实也是提供 http/https 的一种服务，在 FOFA 网络空间资产测绘中，根据协议返回信息不同将其分为了这两类。网站的协议返回信息有 html 源代码，而服务没有。
<a href="https://imgur.com/yDKDYqw"><img src="https://i.imgur.com/yDKDYqw.png" title="区分网站和服务" /></a>

在 FOFA 中有3个地方可以明显区分服务和网站：
1. 和查询关键词type做与查询（&&）。
    "关键词" && type="subdomain"查询的结果为网页；  
    "关键词" && type="service"查询结果为服务。

2. 类型分布。"协议"对应的就是服务；"网站"对应的就是含有html的网站。

3. 网页html源代码按钮、查重按钮有无。下方有两个按钮：html源代码按钮和查重按钮。 若有这两个按钮，则为网站；反之，为服务。


![服务和网站的可提取字段](https://i.imgur.com/iRsea3r.png)
<center>服务和网站的可提取字段</center>


总结为，为了精确定位产品，进而从http/https服务中提取更多有价值的信息，把扫描结果中的网站单独区分开来。


#### 提取服务规则 ####
A. 根据不同协议提取“主关键词”(含有多个字段)。

B. 分析此“关键词”中是否含有能提取信息（类型、厂商和产品型号的字段）？
    - B1是，提取字段，生成“待查询表达式（如banner="字段1"）；
    - B2否（有些字段无法提取，如十六进制码，跳过主关键词，提取结束。

C. 执行查询“待查询表达式”，是否有查询结果？
    - 是，记录查询结果数；执行D
    - 否，执行B1

D. 产品唯一，而且查询结果最多？
    - 是，执行E
    - 否，执行B1

E. 搜索引擎查询该字段确定类型、厂商、厂商官方网站和产品型号。 

F. 遵守规则规范，将规则录入。

![提取服务规则](https://i.imgur.com/Qejp6Iv.png)

>示例：
规则： banner=“ZyWALL-USG-20"     
A. 观察原始数据，提取关键词 ZyWALL USG 20（主观推测是ZyWALL的一个产品，型号可能是USG 20）
B. 搜索引擎查询确认，这是ZyWALL的安全网关，型号为USG 20
C. 生成查询语句：banner=“ZyWALL-USG-20”

![](https://i.imgur.com/Y5pL9kP.png)![](https://i.imgur.com/4ogDGVO.png)
注： 协议相关的查询关键词 banner

#### 提取网站规则 ####

A. 根据查询关键词构建第一次查询表达式  
B. FOFA查询       
C. 查询结果中打开IP地址对应的网页信息
D. 打开网页的源代码 
E. 提取相关信息（相关信息是可以准确定位产品的关键字段）
F. 再次构建查询表达式，再次执行查询。

G. 规则正确性检查：如果是规则：执行I，规则提取结束。反之，构建“新表达式”，使用“表达式”再次执行b操作

H. Google/Bing 查询关键词，确定产品类别、产品型号、厂商和厂商官网

I. 遵守规则录入规范，规则录入，规则录入结束。
![](https://i.imgur.com/LrwpeGs.png)

>示例：
规则： title="Brother MFC-L8900CDW series" 
A. 观察原始数据，猜测可能是某一产品系列，提取整个title作为关键词，可能是Brother公司的产品，型号为MFC-L8900CDW
B. FOFA查询，选择任意一个IP地址，打开源码，观察可作为查询语句提取的网页特征，发现body中的 href="http://solutions.brother.com/cgi-bin/solutions.cgi?"，可用来构建二次查询表达式。
C. 生成查询语句： body="href="http://solutions.brother.com/cgi-bin/solutions.cgi?\""  分别与 title="Brother MFC-L8900CDW series" 用“||”和“&&”联合查询。
D. 查询发现，或查询后，出现了许多其他型号的产品系列；而与查询之后，结果数与单独查询 title 的结果数相同，且都为同一系列的产品。因此，将 title 锁定为规则查询表达式。
E.为了确认规则语句查询结果是最全的，需要多次重复构建表达式、执行查询、分析和验证。
F.正确的规则：
 title="Brother MFC-L8900CDW series"

注： 网页相关的查询关键词有 title、header、body、server、cert

<h4>规则录入</h4>
录入流程主要是针对录入界面的几个字段：

   1. 分类选择（这个规则对应的产品属于什么类别）选择返回类别信息量最多的进行分类

   2. 厂商网站（这个产品生产厂商的 URL）

   3. 厂商名 （厂商全称）有限公司/ltd

   4. 规则名（厂商-产品型号缩写）

   5. 规则内容（提取的规则内容）
	Brother-MFC-L8900CDW-series
![](https://i.imgur.com/4PvsWXO.png)

#### FYI ####
1. 规则提取难点
查询语句中只能出现以下分词符：点（“.”）、冒号（“ : ”）、中横线（“-”）和斜杠（“/”）；
录入规则旨在提取最优字段、覆盖最全的IP数量；尽量使用title + body 结合查询（网页）以防OEM的情况；
避免用href查询取到相关页

2. 规则录入难点
不确定产品其类型、厂商和型号：无意义
不确定厂商：录入此规则可以对与其涵盖的IP地址打厂商标签